<!-- Wrap everything in a single container so it all gets removed on close -->
<div id="analysis-report-wrapper" hx-trigger="load" hx-get="/api/check_extraction_status/{{ url }}" hx-swap="none">
    {% if cached %}
    <div class="alert alert-info alert-dismissible fade show mb-3" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi bi-clock-history me-2"></i> 
            <strong class="me-2">Cached Result:</strong> This analysis was performed on {{ created_at }}
            <button type="button" class="btn btn-primary ms-3" data-bs-toggle="modal" data-bs-target="#refreshModal">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh Analysis
            </button>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Refresh Confirmation Modal -->
    <div class="modal fade" id="refreshModal" tabindex="-1" aria-labelledby="refreshModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="refreshModalLabel">Confirm Refresh</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to refresh this analysis? This will consume additional API tokens and may take a minute to complete.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" 
                            hx-post="/analyze?refresh=true" 
                            hx-vals='{"url": "{{ url }}", "model": "{{ model }}"}' 
                            hx-target="#analysis-container"
                            hx-indicator="#loading-indicator"
                            data-bs-dismiss="modal">
                        Refresh Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if refreshed %}
    <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i> Analysis was refreshed successfully on {{ created_at }}
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold">Threat Analysis Report</h5>
            <div>
                <span class="badge bg-info me-2">{{ model }}</span>
                {% if success %}
                <span class="badge bg-success">Completed</span>
                {% else %}
                <span class="badge bg-danger">Failed</span>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <div class="mb-4">
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <h6 class="card-subtitle">
                        Source: <a href="{{ url }}" target="_blank">{{ url }}</a>
                    </h6>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('analysis-content')">
                            <i class="bi bi-clipboard"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="printAnalysis()">
                            <i class="bi bi-printer"></i>
                        </button>
                    {% if cached %}
                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#refreshModal">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    {% endif %}
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-download"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><button class="dropdown-item" hx-get="/export/{{ url }}?format=json" hx-target="#export-status">JSON</button></li>
                                <li><button class="dropdown-item" hx-get="/export/{{ url }}?format=csv" hx-target="#export-status">CSV</button></li>
                                <li><button class="dropdown-item" hx-get="/export/{{ url }}?format=md" hx-target="#export-status">Markdown</button></li>
                                <li><button class="dropdown-item" hx-get="/export/{{ url }}?format=pdf" hx-target="#export-status">PDF</button></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div id="export-status"></div>
            </div>
            
            <!-- Nav tabs -->
            <ul class="nav nav-tabs nav-fill border-bottom mb-3" id="analysisTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active fw-semibold" id="formatted-tab" data-bs-toggle="tab" href="#formatted" role="tab">
                        <i class="bi bi-file-text me-2"></i>Report Analysis
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link fw-semibold" id="raw-tab" data-bs-toggle="tab" href="#raw" role="tab">
                        <i class="bi bi-code-slash me-2"></i>AI Raw Output
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link fw-semibold" id="indicators-tab" data-bs-toggle="tab" href="#indicators" role="tab">
                        <i class="bi bi-shield-lock me-2"></i>Indicators
                        {% if indicators and indicators.total_count > 0 %}
                        <span class="badge bg-primary rounded-pill ms-1">{{ indicators.total_count }}</span>
                        {% endif %}
                    </a>    
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link fw-semibold" id="critical-sectors-tab" data-bs-toggle="tab" href="#critical-sectors" role="tab">
                        <i class="bi bi-building-fill-lock me-2"></i>Critical Sectors
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link fw-semibold" id="mitre-tab" data-bs-toggle="tab" href="#mitre" role="tab">
                        <i class="bi bi-grid-3x3-gap me-2"></i>MITRE ATT&CK
                    </a>
                </li>
            </ul>
            
            <!-- Tab content -->
            <div class="tab-content p-3 rounded-bottom" id="analysis-content">
                <!-- Report Analysis Tab -->
                <div class="tab-pane fade show active" id="formatted" role="tabpanel" aria-labelledby="formatted-tab">
                    {% if structured_data %}
                    
                    <!-- Summary -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2"><i class="bi bi-file-text me-2"></i>Report Summary</h5>
                        {% if structured_data and structured_data.summary %}
                            <p>{{ structured_data.summary }}</p>
                                                        {% else %}
                            <div class="alert alert-warning">
                                No summary available.
                            </div>
                                                        {% endif %}
                    </div>

                    <!-- Source Evaluation -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2"><i class="bi bi-shield-check me-2"></i>Source Evaluation</h5>
                        {% if structured_data and structured_data.source_evaluation %}
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <div class="card h-100">
                                        <div class="card-header">Reliability</div>
                                        <div class="card-body text-center">
                                            {% if structured_data.source_evaluation.reliability %}
                                                {% if structured_data.source_evaluation.reliability is mapping %}
                                                    {% set reliability_level = structured_data.source_evaluation.reliability.LEVEL if structured_data.source_evaluation.reliability.LEVEL is defined else structured_data.source_evaluation.reliability.level %}
                                                    {% else %}
                                                    {% set reliability_level = structured_data.source_evaluation.reliability %}
                                                    {% endif %}
                                                
                                                {% if reliability_level|upper == 'HIGH' %}
                                                    <span class="badge bg-success fs-5">HIGH</span>
                                                {% elif reliability_level|upper == 'MEDIUM' %}
                                                    <span class="badge bg-warning text-dark fs-5">MEDIUM</span>
                                                {% elif reliability_level|upper == 'LOW' %}
                                                    <span class="badge bg-danger fs-5">LOW</span>
                                                    {% else %}
                                                    <span class="badge bg-secondary fs-5">{{ reliability_level }}</span>
                                                    {% endif %}
                                                
                                                {% if structured_data.source_evaluation.reliability is mapping and structured_data.source_evaluation.reliability.JUSTIFICATION is defined %}
                                                    <div class="mt-2 small text-muted">{{ structured_data.source_evaluation.reliability.JUSTIFICATION }}</div>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-secondary fs-5">Unknown</span>
                                            {% endif %}
                                </div>
                            </div>
                        </div>
                                <div class="col-md-4">
                                    <div class="card h-100">
                                        <div class="card-header">Credibility</div>
                                        <div class="card-body text-center">
                                            {% if structured_data.source_evaluation.credibility %}
                                                {% if structured_data.source_evaluation.credibility is mapping %}
                                                    {% set credibility_level = structured_data.source_evaluation.credibility.LEVEL if structured_data.source_evaluation.credibility.LEVEL is defined else structured_data.source_evaluation.credibility.level %}
                                                {% else %}
                                                    {% set credibility_level = structured_data.source_evaluation.credibility %}
                        {% endif %}
                        
                                                {% if credibility_level|upper == 'HIGH' %}
                                                    <span class="badge bg-success fs-5">HIGH</span>
                                                {% elif credibility_level|upper == 'MEDIUM' %}
                                                    <span class="badge bg-warning text-dark fs-5">MEDIUM</span>
                                                {% elif credibility_level|upper == 'LOW' %}
                                                    <span class="badge bg-danger fs-5">LOW</span>
                                                {% else %}
                                                    <span class="badge bg-secondary fs-5">{{ credibility_level }}</span>
                                                {% endif %}
                                                
                                                {% if structured_data.source_evaluation.credibility is mapping and structured_data.source_evaluation.credibility.JUSTIFICATION is defined %}
                                                    <div class="mt-2 small text-muted">{{ structured_data.source_evaluation.credibility.JUSTIFICATION }}</div>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-secondary fs-5">Unknown</span>
                                            {% endif %}
                                </div>
                            </div>
                        </div>
                                <div class="col-md-4">
                                    <div class="card h-100">
                                        <div class="card-header">Source Type</div>
                                        <div class="card-body text-center">
                                            <span class="badge bg-info text-dark fs-5">{{ structured_data.source_evaluation.source_type }}</span>
                                </div>
                            </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                No source evaluation available.
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Threat Actors -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2">
                            <i class="bi bi-people me-2" style="color: var(--accent-blue);"></i>Threat Actors
                        </h5>
                        {% if structured_data and structured_data.threat_actors and structured_data.threat_actors|length > 0 %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th class="bg-elevated text-primary">Actor</th>
                                            <th class="bg-elevated text-primary">Confidence</th>
                                            <th class="bg-elevated text-primary">Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for actor in structured_data.threat_actors %}
                                        <tr class="threat-actor-row">
                                            <td>
                                                <div class="d-flex flex-column">
                                                    <strong class="actor-name">{{ actor.name }}</strong>
                                                    {% if actor.aliases and actor.aliases|length > 0 %}
                                                        <div class="small text-muted mt-1">
                                                            <i class="bi bi-person-badge me-1"></i>
                                                            aka: {{ actor.aliases|join(', ') }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                {% if actor.confidence == 'High' %}
                                                    <span class="badge confidence-badge high">
                                                        <i class="bi bi-shield-fill-check me-1"></i>{{ actor.confidence }}
                                                    </span>
                                                {% elif actor.confidence == 'Medium' %}
                                                    <span class="badge confidence-badge medium">
                                                        <i class="bi bi-shield-fill me-1"></i>{{ actor.confidence }}
                                                    </span>
                                                {% elif actor.confidence == 'Low' %}
                                                    <span class="badge confidence-badge low">
                                                        <i class="bi bi-shield me-1"></i>{{ actor.confidence }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge confidence-badge unknown">
                                                        <i class="bi bi-question-circle me-1"></i>{{ actor.confidence }}
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td class="description">{{ actor.description }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-warning border-warning bg-opacity-10">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                No threat actors identified in this analysis.
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Key Insights -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2"><i class="bi bi-lightbulb me-2"></i>Key Threat Intelligence Insights</h5>
                        {% if structured_data and structured_data.key_insights and structured_data.key_insights|length > 0 %}
                            <ul class="list-group mb-3">
                                {% for insight in structured_data.key_insights %}
                                    <li class="list-group-item">{{ insight }}</li>
                                    {% endfor %}
                            </ul>
                        {% else %}
                            <div class="alert alert-warning">
                                No key insights identified in this analysis.
                            </div>
                                    {% endif %}
                                </div>
                    
                    <!-- Potential Source Bias -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2"><i class="bi bi-shield-exclamation me-2"></i>Potential Source Bias</h5>
                        {% if structured_data and structured_data.potential_bias and structured_data.potential_bias|length > 0 %}
                            <ul class="list-group mb-3">
                                {% for bias in structured_data.potential_bias %}
                                    <li class="list-group-item">{{ bias }}</li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="alert alert-info">
                                No significant source bias identified.
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Intelligence Gaps -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2"><i class="bi bi-patch-question me-2"></i>Intelligence Gaps</h5>
                        {% if structured_data and structured_data.intelligence_gaps and structured_data.intelligence_gaps|length > 0 %}
                            <ul class="list-group mb-3">
                                {% for gap in structured_data.intelligence_gaps %}
                                    <li class="list-group-item">{{ gap }}</li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="alert alert-info">
                                No significant intelligence gaps identified.
                        </div>
                        {% endif %}
                    </div>
                    
                    {% else %}
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Failed to parse analysis data
                                                    </div>
                                            {% endif %}
                                </div>
                
                <!-- Raw Output Tab -->
                <div class="tab-pane fade" id="raw" role="tabpanel" aria-labelledby="raw-tab">
                    <h4 class="border-bottom pb-2 mb-4 text-primary"><i class="bi bi-code-slash me-2"></i>Raw Analysis Data</h4>
                    
                    {% if result %}
                        <div class="bg-dark text-light p-3 rounded raw-json-container">
                            <pre class="mb-0"><code id="json-content">{{ result }}</code></pre>
                        </div>
                        <div class="d-flex justify-content-center mt-3 gap-2">
                            <button id="copyJsonBtn" class="btn btn-primary" onclick="copyRawJson()">
                                <i class="bi bi-clipboard me-1"></i> Copy JSON
                            </button>
                            <a href="/debug/raw-json?url={{ url | urlencode }}" class="btn btn-secondary">
                                <i class="bi bi-download me-1"></i> Download Raw JSON
                            </a>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            Raw analysis text is not available.
                        </div>
                    {% endif %}
                </div>
                
                <!-- Indicators Tab -->
                <div class="tab-pane fade" id="indicators" role="tabpanel" aria-labelledby="indicators-tab">
                    <h4 class="border-bottom pb-2 mb-4 text-primary"><i class="bi bi-shield-lock me-2"></i>Indicators of Compromise</h4>
                    
                    {% if indicators and indicators.total_count > 0 %}
                        {% for category in indicators.categories %}
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">{{ category.name }}</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="nav nav-tabs mb-3" role="tablist">
                                        {% for type_info in category.types %}
                                            {% if type_info.indicator_values|length > 0 %}
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link {% if loop.first %}active{% endif %}" 
                                                        id="ioc-{{ category.name|lower|replace(' ', '-') }}-{{ type_info.type|replace(' ', '-')|lower }}-tab" 
                                                        data-bs-toggle="tab" 
                                                        data-bs-target="#ioc-{{ category.name|lower|replace(' ', '-') }}-{{ type_info.type|replace(' ', '-')|lower }}" 
                                                        type="button" 
                                                        role="tab" 
                                                        aria-controls="ioc-{{ category.name|lower|replace(' ', '-') }}-{{ type_info.type|replace(' ', '-')|lower }}" 
                                                        aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                                                        {{ type_info.type }}
                                                        <span class="badge bg-primary ms-1">{{ type_info.count }}</span>
                                                    </button>
                                                </li>
                                            {% endif %}
                                        {% endfor %}
                                    </ul>
                                    
                                    <div class="tab-content">
                                        {% for type_info in category.types %}
                                            {% if type_info.indicator_values|length > 0 %}
                                                <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                                                    id="ioc-{{ category.name|lower|replace(' ', '-') }}-{{ type_info.type|replace(' ', '-')|lower }}" 
                                                    role="tabpanel" 
                                                    aria-labelledby="ioc-{{ category.name|lower|replace(' ', '-') }}-{{ type_info.type|replace(' ', '-')|lower }}-tab">
                                                    <div class="table-responsive">
                                                        <table class="table table-hover table-striped">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th scope="col">Value</th>
                                                                    <th scope="col">Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for item in type_info.indicator_values %}
                                                                    <tr>
                                                                        <td><code>{{ item }}</code></td>
                                                                        <td>
                                                                            <div class="btn-group btn-group-sm" role="group">
                                                                                <button type="button" class="btn btn-outline-secondary" onclick="copyToClipboard('{{ item }}')">
                                                                                    <i class="bi bi-clipboard"></i>
                                                                                </button>
                                                                                <a href="https://www.virustotal.com/gui/search/{{ item }}" target="_blank" class="btn btn-outline-secondary">
                                                                                    <i class="bi bi-search"></i> VT
                                                                                </a>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-warning">
                            No indicators of compromise were found in this article.
                        </div>
                    {% endif %}
                </div>
                
                <!-- Critical Sectors Tab -->
                <div class="tab-pane fade" id="critical-sectors" role="tabpanel" aria-labelledby="critical-sectors-tab">
                    <h4 class="border-bottom pb-2 mb-4 text-primary"><i class="bi bi-building-fill-lock me-2"></i>Critical Infrastructure Impact</h4>
                    
                    {% if structured_data and structured_data.critical_sectors and structured_data.critical_sectors|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Sector</th>
                                        <th>Impact</th>
                                        <th>Score</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                    {% for sector in structured_data.critical_sectors %}
                                        <tr>
                                            <td>{{ sector.name }}</td>
                                            <td>{{ sector.impact }}</td>
                                            <td>
                                                {% if sector.score == 1 %}
                                                    <span class="badge bg-info">1</span>
                                                {% elif sector.score == 2 %}
                                                    <span class="badge bg-primary">2</span>
                                                {% elif sector.score == 3 %}
                                                    <span class="badge bg-warning">3</span>
                                                {% elif sector.score == 4 %}
                                                    <span class="badge bg-orange">4</span>
                                                {% elif sector.score == 5 %}
                                                    <span class="badge bg-danger">5</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ sector.score }}</span>
                                                {% endif %}
                                            </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <i class="bi bi-info-circle me-2"></i>Impact Legend
                                    </div>
                            <div class="card-body">
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="badge bg-info">1</span> <span class="me-3">Minimal impact</span>
                                    <span class="badge bg-primary">2</span> <span class="me-3">Low impact</span>
                                    <span class="badge bg-warning">3</span> <span class="me-3">Moderate impact</span>
                                    <span class="badge bg-orange">4</span> <span class="me-3">Significant impact</span>
                                    <span class="badge bg-danger">5</span> <span class="me-3">Severe impact</span>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            No critical infrastructure sectors were identified in this analysis.
                            </div>
                            {% endif %}
                </div>
                
                <!-- MITRE ATT&CK Tab -->
                <div class="tab-pane fade" id="mitre" role="tabpanel" aria-labelledby="mitre-tab">
                    <h4 class="border-bottom pb-2 mb-4 text-primary"><i class="bi bi-grid-3x3 me-2"></i>MITRE ATT&CK Techniques</h4>
                    
                    {% if structured_data and structured_data.mitre_techniques and structured_data.mitre_techniques|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                        <thead>
                                            <tr>
                                        <th>ID</th>
                                        <th>Technique</th>
                                        <th>Description</th>
                                        <th>Link</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                    {% for technique in structured_data.mitre_techniques %}
                                        <tr>
                                            <td><code>{{ technique.id }}</code></td>
                                            <td>{{ technique.name }}</td>
                                            <td>{{ technique.description }}</td>
                                            <td>
                                                <a href="https://attack.mitre.org/techniques/{{ technique.id }}/" target="_blank" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-box-arrow-up-right me-1"></i>View
                                                </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                    {% else %}
                        <div class="alert alert-warning">
                            No MITRE ATT&CK techniques were identified in this analysis.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced logging with timestamps
function log(message) {
    const timestamp = new Date().toISOString().substr(11, 8);
    console.log(`[${timestamp}] [ThreatAnalyzer] ${message}`);
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    log("DOM loaded, setting up Raw tab handlers");

    // Format raw JSON on page load if raw tab is active
    const activeTab = document.querySelector('.nav-link.active');
    if (activeTab && activeTab.getAttribute('href') === '#raw') {
        log("Raw tab active on load, scheduling formatting");
        // Use multiple delayed attempts to ensure content is loaded
        setTimeout(formatRawJson, 100);
        setTimeout(formatRawJson, 500);
        setTimeout(formatRawJson, 1000);
    }
    
    // Format when switching to raw tab
    document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(function(tab) {
        tab.addEventListener('shown.bs.tab', function(event) {
            if (event.target.getAttribute('href') === '#raw') {
                log("Raw tab activated, formatting JSON");
                formatRawJson();
                // Try again after a delay to ensure content is fully loaded
                setTimeout(formatRawJson, 300);
            }
        });
    });
    
    // Attach event handler to copy button (in addition to the onclick attribute)
    const copyBtn = document.getElementById('copyJsonBtn');
    if (copyBtn) {
        copyBtn.addEventListener('click', function(e) {
            // Prevent default to ensure our handler runs
            e.preventDefault();
            copyJsonContent();
        });
    }
});

// Main function to format the JSON content
function formatRawJson() {
    log("Starting JSON formatting");
    const jsonContainer = document.querySelector('#json-content');
    
    if (!jsonContainer) {
        log("ERROR: JSON container not found");
        return;
    }
    
    // Get the raw text content
    const rawText = jsonContainer.textContent.trim();
    if (!rawText) {
        log("ERROR: JSON content is empty");
        return;
    }
    
    log(`JSON content length: ${rawText.length} chars`);
    
    // Try to parse and format the JSON
    try {
        log("Attempting to parse JSON");
        const parsedJson = JSON.parse(rawText);
        const prettyJson = JSON.stringify(parsedJson, null, 2);
        log("JSON parsed successfully, applying pretty formatting");
        
        // Apply syntax highlighting
        const highlighted = applySyntaxHighlighting(prettyJson);
        jsonContainer.innerHTML = highlighted;
        log("JSON formatting complete");
    } catch (e) {
        log(`ERROR parsing JSON: ${e.message}`);
        log("Falling back to manual formatting");
        
        // Apply manual formatting with basic indentation
        const manuallyFormatted = manuallyFormatJson(rawText);
        jsonContainer.innerHTML = manuallyFormatted;
    }
}

// Apply syntax highlighting to JSON content
function applySyntaxHighlighting(text) {
    // Escape HTML characters first
    let escaped = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    
    // Apply color highlighting
    return escaped.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function(match) {
        let cls = 'json-number';
        if (/^"/.test(match)) {
            if (/:$/.test(match)) {
                cls = 'json-key';
            } else {
                cls = 'json-string';
            }
        } else if (/true|false/.test(match)) {
            cls = 'json-boolean';
        } else if (/null/.test(match)) {
            cls = 'json-null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
    });
}

// Manually format JSON when parsing fails
function manuallyFormatJson(text) {
    log("Applying manual JSON formatting");
    let result = '';
    let indentLevel = 0;
    let inString = false;
    
    // Simple manual formatter for when JSON.parse fails
    for (let i = 0; i < text.length; i++) {
        const char = text.charAt(i);
        
        // Handle string literals
        if (char === '"' && (i === 0 || text.charAt(i-1) !== '\\')) {
            inString = !inString;
            result += char;
            continue;
        }
        
        if (!inString) {
            // Handle structural elements
            if (char === '{' || char === '[') {
                result += char + '\n' + ' '.repeat((indentLevel + 1) * 2);
                indentLevel++;
            } else if (char === '}' || char === ']') {
                indentLevel = Math.max(0, indentLevel - 1);
                result += '\n' + ' '.repeat(indentLevel * 2) + char;
            } else if (char === ',') {
                result += char + '\n' + ' '.repeat(indentLevel * 2);
            } else if (char === ':') {
                result += char + ' ';
            } else {
                result += char;
            }
        } else {
            // Inside string, just add the character
            result += char;
        }
    }
    
    // Escape HTML and apply basic highlighting
    return applySyntaxHighlighting(result);
}

// Function to copy JSON content to clipboard
function copyJsonContent() {
    log("Copying JSON to clipboard");
    const jsonContainer = document.querySelector('#json-content');
    
    if (!jsonContainer) {
        log("ERROR: JSON container not found for copying");
        showToast("Error", "Could not find JSON content to copy", "danger");
        return;
    }
    
    const textToCopy = jsonContainer.textContent;
    log(`Copying ${textToCopy.length} characters`);
    
    // Use the fallback approach first since it's more reliable
    try {
        log("Using fallback clipboard approach");
        const textArea = document.createElement('textarea');
        textArea.value = textToCopy;
        textArea.style.position = 'fixed';  // Ensure it's always visible
        textArea.style.opacity = '0';
        textArea.style.top = '0';
        textArea.style.left = '0';
        textArea.style.width = '2em';
        textArea.style.height = '2em';
        textArea.style.padding = '0';
        textArea.style.border = 'none';
        textArea.style.outline = 'none';
        textArea.style.boxShadow = 'none';
        textArea.style.background = 'transparent';
        
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);
        
        if (successful) {
            log("Copy successful using execCommand");
            showToast("Success", "JSON copied to clipboard", "success");
            return;
        } else {
            log("execCommand copy failed, trying clipboard API");
        }
    } catch (err) {
        log(`Fallback copy error: ${err.message}`);
    }
    
    // Try the modern clipboard API as a backup
    if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
        log("Using Clipboard API");
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                log("Clipboard API copy successful");
                showToast("Success", "JSON copied to clipboard", "success");
            })
            .catch(err => {
                log(`Clipboard API error: ${err.message}`);
                showToast("Error", "Failed to copy. Try again or use the Download button.", "danger");
            });
    } else {
        log("Clipboard API not available");
        showToast("Warning", "Copy completed but may not work in this browser. Try the Download button instead.", "warning");
    }
}

// Function to copy raw JSON directly (triggered by button onclick)
function copyRawJson() {
    copyJsonContent();
}

// Toast notification function
function showToast(title, message, type) {
    log(`Showing toast: ${title} - ${message}`);
    
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-${type} text-white">
                <strong class="me-auto">${title}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.getElementById(toastId);
    
    // Make sure Bootstrap is loaded before trying to initialize the toast
    if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
        const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 3000
        });
        toast.show();
    } else {
        // Fallback if Bootstrap JS is not loaded
        toastElement.style.display = 'block';
        setTimeout(() => {
            toastElement.remove();
        }, 3000);
    }
    
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

// Trigger a formatting on load to ensure it happens
setTimeout(formatRawJson, 50);

// Function to copy text to clipboard
function copyToClipboard(text) {
    // Create a temporary textarea element
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.setAttribute('readonly', '');
    textarea.style.position = 'absolute';
    textarea.style.left = '-9999px';
    document.body.appendChild(textarea);
    
    // Select the text and copy it
    textarea.select();
    document.execCommand('copy');
    
    // Remove the textarea
    document.body.removeChild(textarea);
    
    // Show feedback toast
    showToast('Copied', `"${text.substring(0, 30)}${text.length > 30 ? '...' : ''}" copied to clipboard`, 'success');
}
</script>

<style>
.nav-tabs {
    border-bottom: var(--border-subtle);
    background: linear-gradient(180deg, var(--bg-secondary), var(--bg-tertiary));
    border-radius: var(--radius-md) var(--radius-md) 0 0;
    padding: 0.25rem 0.25rem 0;
}

.nav-tabs .nav-link {
    color: var(--text-secondary);
    transition: all var(--transition-normal);
    padding: 0.75rem 1.25rem;
    position: relative;
    border: 1px solid transparent;
    margin-right: 0.25rem;
    border-radius: var(--radius-md) var(--radius-md) 0 0;
    background: transparent;
}

.nav-tabs .nav-link:hover {
    color: var(--text-primary);
    background: rgba(59, 130, 246, 0.1);
    border-color: rgba(59, 130, 246, 0.2);
    transform: translateY(-1px);
}

.nav-tabs .nav-link.active {
    color: var(--accent-blue);
    background: var(--bg-secondary);
    border-color: var(--accent-blue);
    border-bottom-color: transparent;
    font-weight: 600;
    box-shadow: 0 -2px 8px rgba(59, 130, 246, 0.2);
}

.nav-tabs .nav-link.active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, 
        rgba(59, 130, 246, 0) 0%, 
        rgba(59, 130, 246, 0.7) 50%, 
        rgba(59, 130, 246, 0) 100%
    );
    box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
}

.nav-tabs .nav-link .badge {
    font-size: 0.75em;
    padding: 0.35em 0.65em;
    background: rgba(59, 130, 246, 0.2);
    border: 1px solid rgba(59, 130, 246, 0.3);
    color: var(--accent-blue);
    transition: all var(--transition-normal);
}

.nav-tabs .nav-link:hover .badge {
    background: rgba(59, 130, 246, 0.3);
    transform: scale(1.05);
}

.nav-tabs .nav-link.active .badge {
    background: var(--accent-blue);
    color: white;
    box-shadow: 0 0 8px rgba(59, 130, 246, 0.4);
}

.nav-tabs .nav-link i {
    color: var(--text-muted);
    transition: all var(--transition-normal);
}

.nav-tabs .nav-link:hover i {
    color: var(--text-primary);
}

.nav-tabs .nav-link.active i {
    color: var(--accent-blue);
}

/* Threat Actors Section Styling */
.threat-actor-row {
    background-color: var(--bg-secondary);
    transition: all var(--transition-normal);
}

.threat-actor-row:hover {
    background-color: var(--bg-elevated);
    transform: translateX(2px);
    box-shadow: -2px 0 0 var(--accent-blue);
}

.actor-name {
    color: var(--text-primary);
    font-family: var(--heading-font);
    letter-spacing: 0.02em;
}

.confidence-badge {
    padding: 0.5rem 0.75rem;
    font-size: 0.85rem;
    font-weight: 500;
    border-radius: var(--radius-md);
    transition: all var(--transition-normal);
}

.confidence-badge:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
}

.confidence-badge.high {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.confidence-badge.medium {
    background: rgba(245, 158, 11, 0.2);
    color: var(--warning);
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.confidence-badge.low {
    background: rgba(239, 68, 68, 0.2);
    color: var(--danger);
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.confidence-badge.unknown {
    background: rgba(148, 163, 184, 0.2);
    color: var(--text-secondary);
    border: 1px solid rgba(148, 163, 184, 0.3);
}

.description {
    color: var(--text-primary);
    font-size: 0.95rem;
    line-height: 1.5;
}

/* Table header styling */
.table thead th {
    background-color: var(--bg-elevated);
    color: var(--text-primary);
    font-family: var(--heading-font);
    letter-spacing: 0.02em;
    border-bottom: var(--border-subtle);
    padding: 1rem;
}

/* Alert styling */
.alert-warning {
    background-color: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.2);
    color: var(--warning);
}

.alert-warning i {
    color: var(--warning);
}
</style>